# 飞书链接转附件插件 - 防盗链升级版

## 概述

此插件是基于飞书官方"链接转附件"插件架构开发的升级版本，专门解决防盗链图片链接转换问题。

## 核心功能

### ✅ 官方原有功能（完全保留）
- **URL字段选择**：选择包含链接的文本字段
- **附件字段选择**：选择目标附件字段
- **文件上传**：自动将下载的文件上传到飞书
- **记录更新**：自动更新多维表格记录

### 🆕 升级功能（新增）
- **授权码输入**：支持需要认证的图片链接，可输入授权码
- **防盗链处理**：专门处理s.500fd.com等防盗链图片
- **谷歌浏览器优化**：智能User-Agent和Referer处理
- **多重下载策略**：直接下载失败时自动使用代理服务

## 技术特点

### 基于官方架构
- 使用 `@lark-base-open/js-sdk` 官方SDK
- 遵循飞书插件开发规范
- 兼容官方插件的使用方式

### 防盗链处理
- **URL清理**：自动移除可能导致问题的特殊参数
- **请求头优化**：模拟Chrome浏览器请求头
- **代理服务备选**：多个代理服务作为后备方案
- **智能识别**：自动识别图片格式和文件名

### 错误处理
- 详细的错误提示信息
- 逐条记录处理，单条失败不影响其他记录
- 完整的日志记录，便于调试

## 使用方法

1. **安装插件**：将插件部署到飞书多维表格
2. **选择字段**：
   - URL字段：选择包含图片链接的文本字段（如"链接"）
   - 附件字段：选择目标附件字段（如"图片"）
3. **配置选项**（可选）：
   - 输入授权码（如果需要）
   - 启用防盗链处理（默认启用）
4. **开始转换**：点击"开始转换"按钮

## 解决的核心问题

### 防盗链图片转换
针对 `s.500fd.com` 等防盗链图片链接，插件能够：
- 绕过防盗链检测机制
- 正确处理403 Forbidden错误
- 自动清理URL中的特殊参数

### 认证链接支持
对于需要认证的图片链接，可以通过输入授权码来访问。

### 谷歌浏览器优化
专门针对谷歌浏览器的请求头进行优化，提高成功率。

## 开发说明

### 项目结构
```
src/
├── App.tsx                 # 主应用组件
├── types/index.ts          # 类型定义
├── services/
│   ├── pluginService.ts    # 主插件服务
│   └── antiLeechService.ts # 防盗链处理服务
└── main.tsx                # 应用入口
```

### 核心逻辑
1. **字段识别**：严格按字段类型识别（文本字段和附件字段）
2. **防盗链下载**：多重策略处理防盗链图片
3. **文件上传**：使用官方API上传文件
4. **记录更新**：使用官方API更新记录

## 兼容性

- ✅ 飞书官方插件架构
- ✅ 谷歌浏览器优化
- ✅ 支持各种图片格式（JPG、PNG、GIF、WebP等）
- ✅ 支持多种防盗链机制

## 注意事项

1. **网络要求**：需要能够访问外部图片链接
2. **权限要求**：需要多维表格的编辑权限
3. **文件大小**：受飞书附件大小限制
4. **使用频率**：建议合理控制转换频率

## 更新日志

### v1.0.0
- 基于飞书官方"链接转附件"插件架构开发
- 添加授权码输入功能
- 添加防盗链图片转换功能
- 针对谷歌浏览器优化
- 保留官方所有原有功能

## 支持与反馈

如有问题或建议，请通过以下方式反馈：
- 飞书文档评论
- GitHub Issues

---

**重要声明**：此插件是在飞书官方"链接转附件"插件基础上进行的升级开发，完全遵循官方插件架构和使用规范。